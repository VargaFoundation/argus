name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            unixodbc-dev \
            libglib2.0-dev \
            libthrift-c-glib-dev \
            thrift-compiler \
            libcmocka-dev \
            libcurl4-openssl-dev \
            libjson-glib-dev

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Unit Tests
        run: cd build && ctest --output-on-failure -L unit

      - name: Check shared library exports
        run: |
          nm -D build/src/libargus_odbc.so | grep ' T SQL' | head -20
          echo "---"
          echo "Total exported SQL functions:"
          nm -D build/src/libargus_odbc.so | grep -c ' T SQL'

  build-windows:
    runs-on: windows-latest
    environment: main

    env:
      CODESIGN_CERT: ${{ secrets.CODESIGN_CERT }}
      CODESIGN_PASSWORD: ${{ secrets.CODESIGN_PASSWORD }}

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: false
          cache: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-pkgconf
            mingw-w64-ucrt-x86_64-glib2
            mingw-w64-ucrt-x86_64-curl
            mingw-w64-ucrt-x86_64-json-glib
            mingw-w64-ucrt-x86_64-cmocka
            mingw-w64-ucrt-x86_64-nsis

      - name: Configure
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build

      - name: Unit Tests
        run: cd build && ctest --output-on-failure -L unit

      - name: Prepare installer files
        run: |
          mkdir -p installer/staging
          cp build/src/libargus_odbc.dll installer/staging/argus_odbc.dll
          # Bundle runtime dependencies
          for dll in libcurl-4.dll libglib-2.0-0.dll libgobject-2.0-0.dll \
                     libjson-glib-1.0-0.dll libgio-2.0-0.dll libgmodule-2.0-0.dll \
                     libintl-8.dll libiconv-2.dll libffi-8.dll libz1.dll \
                     libzstd.dll libbrotlidec.dll libbrotlicommon.dll \
                     libnghttp2-14.dll libssh2-1.dll libssl-3-x64.dll \
                     libcrypto-3-x64.dll libnghttp3-9.dll libidn2-0.dll \
                     libpsl-5.dll libunistring-5.dll libpcre2-8-0.dll; do
            src="$MINGW_PREFIX/bin/$dll"
            if [ -f "$src" ]; then
              cp "$src" installer/staging/
            fi
          done
          ls -la installer/staging/

      - name: Build NSIS installer
        run: |
          cd installer/staging
          makensis -NOCD ../argus-odbc.nsi

      - name: Sign installer
        if: env.CODESIGN_CERT != ''
        shell: powershell
        run: |
          $certBytes = [Convert]::FromBase64String($env:CODESIGN_CERT)
          $certPath = "$env:RUNNER_TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" -Recurse -Filter signtool.exe | Where-Object { $_.FullName -match "x64" } | Select-Object -First 1 -ExpandProperty FullName
          & $signtool sign /f $certPath /p $env:CODESIGN_PASSWORD /fd SHA256 /tr http://timestamp.sectigo.com /td SHA256 "installer\staging\argus-odbc-installer.exe"
          Remove-Item $certPath

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: argus-odbc-installer
          path: installer/staging/argus-odbc-installer.exe
